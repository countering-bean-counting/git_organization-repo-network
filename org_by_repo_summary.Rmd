---
title: "Organization Commit Summaries"
author: "Augustina Ragwitz"
date: r! Sys.Date()
params:
  clearbit_api_key: !r Sys.getenv("API_KEY_CLEARBIT")
  gh_id: !r Sys.getenv("API_KEY_GITHUB_ID")
  gh_secret: !r Sys.getenv("API_KEY_GITHUB_SECRET")
  gh_token: !r Sys.getenv("API_KEY_GITHUB_TOKEN")
output:
  html_document:
    toc: TRUE
---


```{r includes, message=FALSE, include=FALSE}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(gh)
library(httr)
library(jsonlite)
library(lubridate)
library(readr)
library(stringr)
library(tidyr)
```

# Overview

Public commit activity can provide insight into open source contribution of activity among top technology companies with a Github presence. 

## Methodology

Given a list of companies of interest, identify author activity for recent committers on repositories in the official company Github organization. This excludes repositories and organizations owned by the author but does not exclude repositories belonging to organizations of which the author is a member. This only samples from committers from the past month. Repositories reported in the final results must show significant activity, either through number and consistency of commits by an author in the recent past or by the number of authors having commits on the project.

### Assumptions

 * The majority of committers on official company repositories were employees of the company at the time the commit was made.
 * Significant activity from company-identified committers on other repositories is company-sanctioned.
 
## Companies of Interest

The following companies were identified as being of interest based on an internal report. I was not able to determine why these companies were chosen.

 * Amazon
 * Cisco
 * Facebook
 * Fujitsu
 * Google
 * Huawei
 * IBM
 * Microsoft
 * Oracle
 * Pivotal
 * Redhat
 
I've added the following companies to the report based on their activity in AI Open Source projects I analyze on a monthly basis.

 * Apple
 * Baidu
 * Intel
 * NVIDIA
 * Samsung
 
 
```{r companies}

# TODO: This description needs to go into overview

# Organizations were found using the following search terms: <company name> github organization
# Organizations were manually verified
# Any listed as a "foundation" or lacking a company logo or company website url were excluded.

# TODO: cite these as sources/footnotes

# https://github.com/collections/open-source-organizations

# Intel - https://software.intel.com/en-us/code-samples/github
# Microsoft - https://opensource.microsoft.com/
# Amazon - https://amzn.github.io/

companies <- read_csv('
Apple,apple
Amazon.com,amzn
Amazon.com,alexa
Amazon.com,aws
Amazon.com,awslabs
Baidu,baidu
Baidu,ecomfe
Baidu,baidu-research
Baidu,baidu-aip
Baidu,fex-team
Cisco,cisco
Cisco,ciscodevnet
Facebook,facebook
Fujitsu,fujitsu
Google,google
Google,googlesamples
Google,googlecloudplatform
Huawei,huawei
Huawei,liteos
Huawei,huaweibigdata
Huawei,huaweicloud
Huawei,huawei-clouds
IBM,ibm
IBM,ibm-cloud
IBM,ibmresearch
IBM,ibmdatascience
IBM,ibm-watson-iot
IBM,watson-explorer
IBM,watson-developer-cloud
Intel,intel
Intel,01org
Intel,intellabs
Intel,intel-bigdata
Intel,intel-cloud
Microsoft,microsoft
Microsoft,azure
Microsoft,aspnet
Microsoft,powershell
NVIDIA,nvidia
NVIDIA,nvidiagameworks
NVIDIA,nvlabs
Oracle,oracle
Pivotal,pivotal-cf
Redhat,rht-labs
Redhat,redhat-openstack
Redhat,redhat-developer
Samsung,samsung
', col_names=c("name","github_org"))

```

# Data Collection

## Github Commits

The following functions use the Github API to identify contributors for companies of interest. Official company repositories were looked up manually and provided in the companies data structure defined above. 

### Github API Base Functions

```{r github_api_functions}

query_params <- list(
  client_id=params$gh_id, 
  client_secret=params$gh_secret)

get_gh_resp <- function (url, query) {
  req <- GET(url, query=query)
  json <- content(req, as = "text")
  resp <- fromJSON(json, flatten = TRUE)
  #resp_df <-  resp %>% unlist() %>% as.data.frame.list()
  return(resp)
}
```

### Latest Active Repositories per Organization

The following functions query the Github API to return a list of the most recently updated repositories for each Github organization.

```{r github_api_org_repos, eval=FALSE}
# get repos updated in the last month for an organization

get_gh_org_repos <- function (org, url, query) {
  org_url <- str_replace(url, ":org", org)
  sha_resp <- get_gh_resp(org_url, query)
}

orgs_url <- "https://api.github.com/orgs/:org/repos"

org_repos = data_frame()
for (n in 1:nrow(companies)) {
  org <- companies$github_org[n]
  org_resp <- get_gh_org_repos(org, orgs_url, query_params)
  
  if (!is.data.frame(org_resp)) {
    print(paste(org, org_resp$message))
    next()
  }
  
  # add the github org and company name for reference
  org_resp <- org_resp %>% 
    mutate(company=companies$name[n], github_org=org)
  
  org_repos <- bind_rows(org_resp, org_repos)
}

write_rds(org_repos, "data/org_repos.Rds")

```

### Latest Commits on Organization Repositories

The following functions query the Github API to return the latest commits on the most recently updated repositories for each company.

```{r github_api_latest_commits, eval=FALSE}

get_gh_commits <- function (url, query) {
  req <- GET(url, query=query, accept("application/vnd.github.cloak-preview"))
  json <- content(req, as = "text")
  resp <- fromJSON(json, flatten = TRUE)
  #resp_df <-  resp %>% unlist() %>% as.data.frame.list()
  return(resp)
}

org_repos <- read_rds("data/org_repos.Rds")
org_commits <- data_frame()

for (n in 1:nrow(org_repos)) {
  commits_url <- str_replace(org_repos$commits_url[n], "\\{/sha\\}", "")
  org_commits_resp <- get_gh_commits(commits_url, query_params)
  
  if (!is.data.frame(org_commits_resp)) {
    print(paste(org_repos$full_name[n], org_commits_resp$message))
    next()
  }
  
  # add the github org and company name for reference
  org_commits_resp <- org_commits_resp %>% 
    mutate(company=org_repos$company[n], github_org=org_repos$github_org[n], repo=org_repos$full_name[n])
  
  org_commits <- bind_rows(org_commits, org_commits_resp)
}

write_rds(org_commits, "data/org_commits.Rds")

# get commits from the past 4 weeks
commits_since <- today() - weeks(4)

org_commits_latest <- org_commits %>%
  filter(commit.committer.date > commits_since)

write_rds(org_commits_latest, "data/org_commits_latest.Rds")

```

### Affliated Authors

The following functions create a list of authors based on the committer information in commits pulled from the organization repositories with github user information pulled from the Github API.

```{r github_api_affiliated_authors, eval=FALSE}

org_commits_latest <- read_rds("data/org_commits_latest.Rds")

committers <- org_commits_latest %>%
  group_by(company) %>%
  mutate(num_orgs = n_distinct(github_org),
         num_repos = n_distinct(repo)) %>%
  group_by(company, committer.login) %>%
  summarise(num_org_commits=n(), num_orgs=first(num_orgs), num_repos=first(num_repos))

write_rds(committers, "data/committers.Rds")
write_csv(committers, "data/committers.csv")
```

The following plot shows the distribution of the number of authors

```{r fig-github_api_affiliated_authors}
committers <- read_rds("data/committers.Rds")

# Plot distribution of authors per company
ggplot(committers, aes(x=company)) +
  geom_bar(aes(fill=factor(num_orgs))) +
  coord_flip() +
  labs(title="Distribution of Authors",
       x="Company", 
       y="Count of Committers active in the past Month on Company-owned Repos", 
       fill="# Github Orgs")

```


### Affiliated Authors Sample

Cluster committers by company and take a random sample of 10 committers identified per company. If a company has less than 10, use all of the ones we identified.

```{r affiliated_authors_sample, eval=FALSE}

committers <- read_rds("data/committers.Rds")

committers_sample_base <- committers %>%
  filter(! is.na(committer.login) & ! committer.login %in% c("web-flow")) %>%
  group_by(company) %>%
  mutate(num_committers = n_distinct(committer.login))

committers_less_than_sample_size <- committers_sample_base %>%
  filter(num_committers < 10)

committers_sample <- committers_sample_base %>%
  filter(num_committers >= 10) %>%
  sample_n(10)

committers_sample <- bind_rows(committers_sample, committers_less_than_sample_size)

# add org info
org_commits_latest <- read_rds("data/org_commits_latest.Rds")
committers_sample <- committers_sample %>% 
  inner_join(org_commits_latest %>% select(committer.login, github_org)) %>%
  unique()

write_rds(committers_sample, "data/committers_sample.Rds")
write_csv(committers_sample, "data/committers_sample.csv")
```

```{r fig-affiliated_authors_sample}

committers_sample <- read_rds("data/committers_sample.Rds")
# Plot distribution of committers per company
ggplot(committers_sample, aes(x=company)) +
  geom_bar(aes(fill=num_committers < 10)) +
  coord_flip() +
  labs(title="Author Sample Size Distribution",
       x="Company", 
       y="Author Sample Size per Company")
```

### Affiliated Authors Commits

The following function uses the Github API to look up commits belonging to the authors identified from the organizations' commits. Repositories belonging to the author are excluded.

```{r github_api_affiliated_commits, eval=FALSE}

get_gh_commits <- function (url, query) {
  req <- GET(url, query=query, accept("application/vnd.github.cloak-preview"))
  json <- content(req, as = "text")
  resp <- fromJSON(json, flatten = TRUE)
  #resp_df <-  resp %>% unlist() %>% as.data.frame.list()
  return(resp)
}

search_gh_commits_by_login <- function(login, orgname, query_params) {
  commits_search_url <- "https://api.github.com/search/commits?q="
  
  commits_search_author <- paste("author", login, sep=":")
  commits_search_date <- paste("author-date", ">2018-04-01", sep=":")
  
  commits_search_query <- paste(commits_search_author, sep="+")
  commits_search_url <- paste(commits_search_url, commits_search_query, sep="")
  print(commits_search_url)
  
  commits_resp <- get_gh_commits(commits_search_url, append(query_params, c(per_page=100)))
  return(commits_resp)
}

committers_sample <- read_rds("data/committers_sample.Rds")

affiliated_commits <- data_frame()
for (n in 1:nrow(committers_sample)) {
  print(paste(committers_sample$company[n], committers_sample$committer.login[n]))
  
  # Github API rate limits Search requests to 30 per minute
  if(n %% 30 == 0) {
    print(paste(n, "Rate Limit Nap"))
    Sys.sleep(60)
  }

  commits_resp <- search_gh_commits_by_login(
    committers_sample$committer.login[n], 
    committers_sample$github_org[n], 
    query_params)
  
  commits <- commits_resp$items
  
  commits <- commits %>% 
    mutate(login=committers_sample$committer.login[n], 
           company=committers_sample$company[n],
           github_org=committers_sample$github_org[n])

  affiliated_commits <- bind_rows(affiliated_commits, commits)
}

write_rds(affiliated_commits, "data/affiliated_commits.Rds")
write_csv(affiliated_commits %>% select(-parents), "data/affiliated_commits.csv")

```

```{r affiliated_commits_summary, eval=FALSE}

affiliated_commits <- read_rds("data/affiliated_commits.Rds")

affiliated_commits_summary <- affiliated_commits %>%
  filter(login == author.login) %>%
  group_by(company, repository.full_name) %>%
  summarise(num_authors=n_distinct(login), num_commits=n())

write_rds(affiliated_commits_summary, "data/affiliated_commits_summary.Rds")
write_csv(affiliated_commits_summary, "data/affiliated_commits_summary.csv")

```



### Affiliated Authors Events

The following function uses the Github Archive to look up events belonging to the authors identified from the organizations' commits.

```{r github_archive_affiliated_events}

```


# Analysis

## Project Demographics

### Language

### Committer Diversity

### Maturity

### Type

## Significant Commit Activity

Based on the commit log, what significant activity do we see from the committers?

```{r significant_commits_summary}

affiliated_commits_summary <- read_rds("data/affiliated_commits_summary.Rds")

affiliated_commits_summary <- affiliated_commits_summary %>%
  separate(repository.full_name, c("org", "repo"), sep="/", remove=FALSE)

affiliated_commits_summary <- affiliated_commits_summary %>%
  mutate(org=str_to_lower(org)) %>%
  left_join(companies %>% rename(org_company=name, org=github_org))

affiliated_commits_summary <- affiliated_commits_summary %>%
  mutate(owned_repo = company == org_company,
         owned_repo = ifelse(is.na(owned_repo), FALSE, owned_repo))

owned_org_summary <- affiliated_commits_summary %>%
  group_by(company, org) %>%
  summarise(
    owned_repo=first(owned_repo),
    total_commits=sum(num_commits),
    total_authors=sum(num_authors),
    num_repos=n_distinct(repository.full_name)
  )
```

```{r fig-org-owned_repos}
# proportion of org-owned repository activity vs non-org owned
ggplot(owned_org_summary, aes(x=company, y=num_repos, fill=owned_repo)) +
  geom_bar(stat="identity") +
  coord_flip()

```

```{r fig-top-orgs-commits, fig.height=16, fig.width=10}

# top significant repos per org if a huge list
ggplot(owned_org_summary %>% 
         filter(total_commits > 1, total_authors > 1) %>% 
         group_by(company,org) %>% 
         top_n(10, total_commits), 
       aes(x=reorder(org, total_commits), y=total_commits, fill=owned_repo)) +
  geom_bar(stat="identity", position="stack") +
  coord_flip() +
  facet_wrap(~ company, scales="free", ncol=3) +
  labs(title="Github Projects per Company with Most Commits", x="Github Project", y="Total Commits", fill="Own Repo?")

```

```{r fig-top-orgs-authors, fig.height=16, fig.width=10}

# top significant repos per org if a huge list
ggplot(owned_org_summary %>% 
         filter(total_commits > 1, total_authors > 1) %>% 
         group_by(company,org) %>% 
         top_n(10, total_authors), 
       aes(x=reorder(org, total_authors), y=total_authors, fill=owned_repo)) +
  geom_bar(stat="identity", position="stack") +
  coord_flip() +
  facet_wrap(~ company, scales="free", ncol=3) +
  labs(title="Github Projects per Company with Most Authors", x="Github Project", y="Total Authors", fill="Own Repo?")

```

```{r fig-top-orgs-authors-huawei}

# top significant repos per org if a huge list
ggplot(owned_org_summary %>% 
         filter(company == "Huawei", total_commits > 1, total_authors > 1), 
       aes(x=reorder(org, total_authors), y=total_authors, fill=owned_repo)) +
  geom_bar(stat="identity", position="stack") +
  coord_flip() +
  labs(title="Github Projects with Huawei Authors", x="Github Project", y="Total Authors", fill="Own Repo?")

```

```{r fig-top-orgs-commits-huawei}

# top significant repos per org if a huge list
ggplot(owned_org_summary %>% 
         filter(company == "Huawei", total_commits > 1, total_authors > 1),
       aes(x=reorder(org, total_commits), y=total_commits, fill=owned_repo)) +
  geom_bar(stat="identity", position="stack") +
  coord_flip() +
  labs(title="Github Projects with Huawei Authors", x="Github Project", y="Total Commits", fill="Own Repo?")

```



### Individual Authors

Significance is defined by a large number of commits to a particular project.

```{r significant_commits_author}

```


### Multiple Authors (Same Company)

Significance is defined as the presence of multiple authors from the same company.

```{r significant_commits_multi_authors}

```

### Multiple Companies

Significance is defined as the presence of commits from multiple companies.

```{r significant_commits_multi_company}

```

## Significant Event Activity

```{r significant_events}

# proportion of org-owned repository activity vs non-org owned

# top significant repos per org if a huge list

```

### Multiple Companies

Significance is defined as the presence of events from multiple companies.

```{r significant_events_multi_company}

```


# Summary



